{% extends "base.html" %}

{% block title %}{{ project.name }} - Project Details{% endblock %}

{% block header %}{{ project.name }}{% endblock %}

{% block page_actions %}
<div class="btn-group me-2">
    <a href="{{ url_for('project_management.new_task', project_id=project.id) }}" class="btn btn-sm btn-outline-primary">
        <i class="fas fa-plus me-1"></i> Add Task
    </a>
</div>
<div class="btn-group me-2">
    <a href="{{ url_for('project_management.edit_project', id=project.id) }}" class="btn btn-sm btn-outline-secondary">
        <i class="fas fa-edit me-1"></i> Edit Project
    </a>
</div>
<div class="btn-group">
    <a href="{{ url_for('project_management.project_report', id=project.id) }}" class="btn btn-sm btn-outline-info">
        <i class="fas fa-file-pdf me-1"></i> Generate Report
    </a>
    <button class="btn btn-sm btn-outline-secondary print-btn">
        <i class="fas fa-print me-1"></i> Print
    </button>
</div>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="fw-bold">Client</h6>
                        <p>{{ project.client or 'Not specified' }}</p>
                        
                        {% if project.client_user %}
                        <h6 class="fw-bold">Client User</h6>
                        <p>{{ project.client_user.name }} 
                            {% if project.client_user.is_existing_user %}
                            <span class="badge bg-info">Existing User</span>
                            {% endif %}
                        </p>
                        {% endif %}
                        
                        <h6 class="fw-bold">Platform</h6>
                        <p>
                            <span class="badge {{ 'bg-success' if project.platform == 'fiverr' else 'bg-info' if project.platform == 'upwork' else 'bg-secondary' }}">
                                {{ project.platform|capitalize }}
                            </span>
                            {% if project.platform_project_id %}
                            <span class="text-muted">(ID: {{ project.platform_project_id }})</span>
                            {% endif %}
                        </p>
                        
                        <h6 class="fw-bold">Payment Status</h6>
                        <p>
                            <span class="badge {{ 'bg-success' if project.payment_status == 'transferred' else 'bg-warning text-dark' if project.payment_status == 'in-platform' else 'bg-info text-dark' if project.payment_status == 'in-review' else 'bg-secondary' }}">
                                {{ project.payment_status|replace('-', ' ')|capitalize }}
                            </span>
                        </p>
                        
                        <h6 class="fw-bold">Status</h6>
                        <p>
                            <span class="badge {{ 'bg-success' if project.status == 'completed' else 'bg-warning text-dark' if project.status == 'in-progress' else 'bg-info text-dark' if project.status == 'planning' else 'bg-danger' }}">
                                {{ project.status|replace('-', ' ')|capitalize }}
                            </span>
                        </p>
                    </div>
                    <div class="col-md-6">
                        <h6 class="fw-bold">Start Date</h6>
                        <p>{{ project.start_date | formatdate }}</p>
                        
                        <h6 class="fw-bold">End Date</h6>
                        <p>{{ project.end_date | formatdate if project.end_date else 'Not set' }}</p>
                        
                        {% if project.end_date %}
                        <h6 class="fw-bold">Deadline Timer</h6>
                        <p id="deadline-timer" class="fw-bold">
                            <i class="fas fa-clock me-1"></i>
                            <span id="timer-text"></span>
                        </p>
                        <script>
                            function updateTimer() {
                                const endDate = new Date("{{ project.end_date }}");
                                const now = new Date();
                                const diff = endDate - now;
                                
                                let timerText = '';
                                let cssClass = '';
                                
                                if (diff > 0) {
                                    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                                    const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                                    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                                    const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                                    
                                    timerText = `${days}d ${hours}h ${minutes}m ${seconds}s remaining`;
                                    cssClass = days < 7 ? 'text-warning' : 'text-success';
                                } else {
                                    timerText = 'Deadline passed';
                                    cssClass = 'text-danger';
                                }
                                
                                const timerElement = document.getElementById('deadline-timer');
                                const timerTextElement = document.getElementById('timer-text');
                                timerElement.className = `fw-bold ${cssClass}`;
                                timerTextElement.textContent = timerText;
                            }
                            
                            updateTimer();
                            setInterval(updateTimer, 1000);
                        </script>
                        {% endif %}
                        
                        <h6 class="fw-bold">Budget</h6>
                        <p>{{ "$%.2f"|format(project.budget) if project.budget else 'Not specified' }}</p>
                    </div>
                </div>
                
                <h6 class="fw-bold">Description</h6>
                <p>{{ project.description or 'No description provided' }}</p>
                
                <div class="mt-4">
                    <h6 class="fw-bold">Progress</h6>
                    <div class="d-flex justify-content-between mb-1">
                        <span>{{ project.progress }}% Complete</span>
                        {% if project.budget %}
                        <span>Budget: ${{ "%.2f"|format(project.budget) }}</span>
                        {% endif %}
                    </div>
                    <div class="progress" style="height: 10px;">
                        <div class="progress-bar bg-primary" role="progressbar" style="width: {{ project.progress }}%;" aria-valuenow="{{ project.progress }}" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        {% if project.end_date %}
        <div class="card mb-4">
            <div class="card-header bg-dark text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-hourglass-half me-2"></i>Project Timer
                </h5>
            </div>
            <div class="card-body text-center py-4">
                <div id="deadline-timer">
                    <div id="timer-text" class="display-4 mb-2 fw-bold"></div>
                    <p class="text-muted mb-0">until deadline</p>
                </div>
            </div>
            <script>
                function updateTimer() {
                    const endDate = new Date("{{ project.end_date }}");
                    const now = new Date();
                    const diff = endDate - now;
                    
                    let timerText = '';
                    let cssClass = '';
                    
                    if (diff > 0) {
                        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                        const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                        const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                        
                        timerText = `${days}d ${hours}h ${minutes}m ${seconds}s`;
                        cssClass = days < 7 ? 'text-warning' : 'text-success';
                    } else {
                        timerText = 'Deadline passed';
                        cssClass = 'text-danger';
                    }
                    
                    const timerElement = document.getElementById('timer-text');
                    timerElement.textContent = timerText;
                    timerElement.className = `display-4 mb-2 fw-bold ${cssClass}`;
                }
                
                updateTimer();
                setInterval(updateTimer, 1000);
            </script>
        </div>
        {% endif %}
        
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Task Summary</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6 mb-3">
                        <div class="p-3 rounded bg-dark">
                            <h3>{{ tasks|selectattr('status', 'equalto', 'to-do')|list|length }}</h3>
                            <p class="mb-0 text-muted">To Do</p>
                        </div>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="p-3 rounded bg-dark">
                            <h3>{{ tasks|selectattr('status', 'equalto', 'in-progress')|list|length }}</h3>
                            <p class="mb-0 text-muted">In Progress</p>
                        </div>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="p-3 rounded bg-dark">
                            <h3>{{ tasks|selectattr('status', 'equalto', 'in-review')|list|length }}</h3>
                            <p class="mb-0 text-muted">In Review</p>
                        </div>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="p-3 rounded bg-dark">
                            <h3>{{ tasks|selectattr('status', 'equalto', 'completed')|list|length }}</h3>
                            <p class="mb-0 text-muted">Completed</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">Milestones</h5>
                <a href="{{ url_for('project_management.new_milestone', project_id=project.id) }}" class="btn btn-sm btn-primary">
                    <i class="fas fa-plus me-1"></i> Add
                </a>
            </div>
            <div class="card-body">
                {% if project.milestones %}
                <ul class="list-group list-group-flush">
                    {% for milestone in project.milestones %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">{{ milestone.name }}</h6>
                            <p class="text-muted small mb-1">Due: {{ milestone.due_date | formatdate }}</p>
                            <span class="badge {{ 'bg-success' if milestone.status == 'paid' else 'bg-warning text-dark' if milestone.status == 'completed' else 'bg-secondary' }}">
                                {{ milestone.status|capitalize }}
                            </span>
                        </div>
                        <div class="text-end">
                            <div class="text-muted mb-2">${{ "%.2f"|format(milestone.amount) }}</div>
                            <div class="btn-group btn-group-sm">
                                <a href="{{ url_for('project_management.edit_milestone', id=milestone.id) }}" class="btn btn-outline-primary">
                                    <i class="fas fa-edit"></i>
                                </a>
                            </div>
                        </div>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="text-muted">No milestones added yet</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">Payment Information</h5>
                <a href="{{ url_for('project_management.project_payments', project_id=project.id) }}" class="btn btn-sm btn-primary">
                    <i class="fas fa-money-bill-wave me-1"></i> View All Payments
                </a>
            </div>
            <div class="card-body">
                {% if project.payments %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Status</th>
                                <th>Original Amount</th>
                                <th>Platform Fee</th>
                                <th>Conversion Rate</th>
                                <th>Amount Received</th>
                                <th>Account</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for payment in project.payments %}
                            <tr>
                                <td>{{ payment.payment_date | formatdate if payment.payment_date else 'Not set' }}</td>
                                <td>
                                    <span class="badge {{ 'bg-success' if payment.status == 'reconciled' else 'bg-info' if payment.status == 'transferred' else 'bg-warning text-dark' if payment.status == 'in-platform' else 'bg-secondary' }}">
                                        {{ payment.status|replace('-', ' ')|capitalize }}
                                    </span>
                                </td>
                                <td>{{ payment.currency_original }} {{ "%.2f"|format(payment.amount_original) }}</td>
                                <td>{{ payment.currency_original }} {{ "%.2f"|format(payment.platform_fee) }}</td>
                                <td>{{ "%.6f"|format(payment.conversion_rate) }}</td>
                                <td>{{ payment.currency_received }} {{ "%.2f"|format(payment.amount_received) if payment.amount_received else 'N/A' }}</td>
                                <td>{{ payment.account.name if payment.account else 'Not specified' }}</td>
                                <td>
                                    <div class="btn-group">
                                        <a href="{{ url_for('project_management.edit_payment', id=payment.id) }}" class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-3">
                    <p class="mb-2 text-muted">No payment records added yet</p>
                    <a href="{{ url_for('project_management.new_payment') }}" class="btn btn-primary">
                        <i class="fas fa-plus me-1"></i> Add Payment Record
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">Tasks</h5>
                <a href="{{ url_for('project_management.new_task', project_id=project.id) }}" class="btn btn-sm btn-primary">
                    <i class="fas fa-plus me-1"></i> Add Task
                </a>
            </div>
            <div class="card-body">
                {% if tasks %}
                <ul class="nav nav-tabs mb-3" id="taskTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="all-tab" data-bs-toggle="tab" data-bs-target="#all-tasks" type="button" role="tab" aria-controls="all-tasks" aria-selected="true">All</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="todo-tab" data-bs-toggle="tab" data-bs-target="#todo-tasks" type="button" role="tab" aria-controls="todo-tasks" aria-selected="false">To Do</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="inprogress-tab" data-bs-toggle="tab" data-bs-target="#inprogress-tasks" type="button" role="tab" aria-controls="inprogress-tasks" aria-selected="false">In Progress</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="completed-tab" data-bs-toggle="tab" data-bs-target="#completed-tasks" type="button" role="tab" aria-controls="completed-tasks" aria-selected="false">Completed</button>
                    </li>
                </ul>
                
                <div class="tab-content" id="taskTabsContent">
                    <div class="tab-pane fade show active" id="all-tasks" role="tabpanel" aria-labelledby="all-tab">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Task</th>
                                        <th>Assigned To</th>
                                        <th>Due Date</th>
                                        <th>Time Remaining</th>
                                        <th>Priority</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for task in tasks %}
                                    <tr>
                                        <td>{{ task.title }}</td>
                                        <td>{{ task.assigned_to.username if task.assigned_to else 'Unassigned' }}</td>
                                        <td>{{ task.due_date | formatdate if task.due_date else 'Not set' }}</td>
                                        <td>
                                            {% if task.due_date %}
                                                {% set time_info = task.due_date | time_remaining %}
                                                <span class="{{ time_info.css_class }} fw-bold small">
                                                    <i class="fas fa-clock me-1"></i>
                                                    {{ time_info.time_str }}
                                                </span>
                                            {% else %}
                                                <span class="text-muted">No deadline</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <span class="badge {{ 'bg-danger' if task.priority == 'high' or task.priority == 'urgent' else 'bg-warning text-dark' if task.priority == 'medium' else 'bg-info text-dark' }}">
                                                {{ task.priority|capitalize }}
                                            </span>
                                        </td>
                                        <td>
                                            <span class="badge {{ 'bg-success' if task.status == 'completed' else 'bg-warning text-dark' if task.status == 'in-progress' else 'bg-info text-dark' if task.status == 'in-review' else 'bg-secondary' }}">
                                                {{ task.status|replace('-', ' ')|capitalize }}
                                            </span>
                                        </td>
                                        <td>
                                            <div class="btn-group">
                                                <button type="button" class="btn btn-sm btn-outline-info" data-bs-toggle="modal" data-bs-target="#viewTaskModal{{ task.id }}">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                {% if current_user.is_admin or task.user_id == current_user.id %}
                                                <a href="{{ url_for('project_management.edit_task', id=task.id) }}" class="btn btn-sm btn-outline-primary">
                                                    <i class="fas fa-edit"></i>
                                                </a>
                                                <button type="button" class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteTaskModal{{ task.id }}">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                                {% endif %}
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="tab-pane fade" id="todo-tasks" role="tabpanel" aria-labelledby="todo-tab">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Task</th>
                                        <th>Assigned To</th>
                                        <th>Due Date</th>
                                        <th>Priority</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for task in tasks if task.status == 'to-do' %}
                                    <tr>
                                        <td>{{ task.title }}</td>
                                        <td>{{ task.assigned_to.username if task.assigned_to else 'Unassigned' }}</td>
                                        <td>{{ task.due_date | formatdate if task.due_date else 'Not set' }}</td>
                                        <td>
                                            <span class="badge {{ 'bg-danger' if task.priority == 'high' or task.priority == 'urgent' else 'bg-warning text-dark' if task.priority == 'medium' else 'bg-info text-dark' }}">
                                                {{ task.priority|capitalize }}
                                            </span>
                                        </td>
                                        <td>
                                            <div class="btn-group">
                                                <button type="button" class="btn btn-sm btn-outline-info" data-bs-toggle="modal" data-bs-target="#viewTaskModal{{ task.id }}">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                {% if current_user.is_admin or task.user_id == current_user.id %}
                                                <a href="{{ url_for('project_management.edit_task', id=task.id) }}" class="btn btn-sm btn-outline-primary">
                                                    <i class="fas fa-edit"></i>
                                                </a>
                                                {% endif %}
                                            </div>
                                        </td>
                                    </tr>
                                    {% else %}
                                    <tr>
                                        <td colspan="5" class="text-center">No tasks in To-Do status</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="tab-pane fade" id="inprogress-tasks" role="tabpanel" aria-labelledby="inprogress-tab">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Task</th>
                                        <th>Assigned To</th>
                                        <th>Due Date</th>
                                        <th>Priority</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for task in tasks if task.status == 'in-progress' %}
                                    <tr>
                                        <td>{{ task.title }}</td>
                                        <td>{{ task.assigned_to.username if task.assigned_to else 'Unassigned' }}</td>
                                        <td>{{ task.due_date | formatdate if task.due_date else 'Not set' }}</td>
                                        <td>
                                            <span class="badge {{ 'bg-danger' if task.priority == 'high' or task.priority == 'urgent' else 'bg-warning text-dark' if task.priority == 'medium' else 'bg-info text-dark' }}">
                                                {{ task.priority|capitalize }}
                                            </span>
                                        </td>
                                        <td>
                                            <div class="btn-group">
                                                <button type="button" class="btn btn-sm btn-outline-info" data-bs-toggle="modal" data-bs-target="#viewTaskModal{{ task.id }}">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                {% if current_user.is_admin or task.user_id == current_user.id %}
                                                <a href="{{ url_for('project_management.edit_task', id=task.id) }}" class="btn btn-sm btn-outline-primary">
                                                    <i class="fas fa-edit"></i>
                                                </a>
                                                {% endif %}
                                            </div>
                                        </td>
                                    </tr>
                                    {% else %}
                                    <tr>
                                        <td colspan="5" class="text-center">No tasks in In-Progress status</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="tab-pane fade" id="completed-tasks" role="tabpanel" aria-labelledby="completed-tab">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Task</th>
                                        <th>Assigned To</th>
                                        <th>Due Date</th>
                                        <th>Priority</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for task in tasks if task.status == 'completed' %}
                                    <tr>
                                        <td>{{ task.title }}</td>
                                        <td>{{ task.assigned_to.username if task.assigned_to else 'Unassigned' }}</td>
                                        <td>{{ task.due_date | formatdate if task.due_date else 'Not set' }}</td>
                                        <td>
                                            <span class="badge {{ 'bg-danger' if task.priority == 'high' or task.priority == 'urgent' else 'bg-warning text-dark' if task.priority == 'medium' else 'bg-info text-dark' }}">
                                                {{ task.priority|capitalize }}
                                            </span>
                                        </td>
                                        <td>
                                            <div class="btn-group">
                                                <button type="button" class="btn btn-sm btn-outline-info" data-bs-toggle="modal" data-bs-target="#viewTaskModal{{ task.id }}">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% else %}
                                    <tr>
                                        <td colspan="5" class="text-center">No completed tasks</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-tasks mb-3" style="font-size: 2.5rem;"></i>
                    <h4>No Tasks Found</h4>
                    <p class="text-muted">Start by adding tasks to this project</p>
                    <a href="{{ url_for('project_management.new_task', project_id=project.id) }}" class="btn btn-primary">
                        <i class="fas fa-plus me-1"></i> Add First Task
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Task View Modals -->
{% for task in tasks %}
<div class="modal fade" id="viewTaskModal{{ task.id }}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{ task.title }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <h6 class="fw-bold">Description</h6>
                    <p>{{ task.description or 'No description provided' }}</p>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <h6 class="fw-bold">Assigned To</h6>
                        <p>{{ task.assigned_to.username if task.assigned_to else 'Unassigned' }}</p>
                    </div>
                    <div class="col-md-6">
                        <h6 class="fw-bold">Due Date</h6>
                        <p>{{ task.due_date | formatdate if task.due_date else 'Not set' }}</p>
                        {% if task.due_date %}
                        {% set time_info = task.due_date | time_remaining %}
                        <p class="{{ time_info.css_class }} fw-bold">
                            <i class="fas fa-clock me-1"></i>
                            {{ time_info.time_str }}
                        </p>
                        {% endif %}
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <h6 class="fw-bold">Priority</h6>
                        <p>
                            <span class="badge {{ 'bg-danger' if task.priority == 'high' or task.priority == 'urgent' else 'bg-warning text-dark' if task.priority == 'medium' else 'bg-info text-dark' }}">
                                {{ task.priority|capitalize }}
                            </span>
                        </p>
                    </div>
                    <div class="col-md-6">
                        <h6 class="fw-bold">Status</h6>
                        <p>
                            <span class="badge {{ 'bg-success' if task.status == 'completed' else 'bg-warning text-dark' if task.status == 'in-progress' else 'bg-info text-dark' if task.status == 'in-review' else 'bg-secondary' }}">
                                {{ task.status|replace('-', ' ')|capitalize }}
                            </span>
                        </p>
                    </div>
                </div>
                
                <div class="mb-3">
                    <h6 class="fw-bold">Created</h6>
                    <p>{{ task.created_at | formatdate('%Y-%m-%d %H:%M') }}</p>
                </div>
                
                {% if current_user.is_admin or task.user_id == current_user.id %}
                <div class="card bg-dark mt-4">
                    <div class="card-header">
                        <h6 class="mb-0">Update Status</h6>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <form action="{{ url_for('project_management.update_task_status', id=task.id, status='to-do') }}" method="POST" class="d-inline">
                                <button type="submit" class="btn btn-sm {{ 'btn-secondary' if task.status == 'to-do' else 'btn-outline-secondary' }}">To Do</button>
                            </form>
                            
                            <form action="{{ url_for('project_management.update_task_status', id=task.id, status='in-progress') }}" method="POST" class="d-inline">
                                <button type="submit" class="btn btn-sm {{ 'btn-warning' if task.status == 'in-progress' else 'btn-outline-warning' }}">In Progress</button>
                            </form>
                            
                            <form action="{{ url_for('project_management.update_task_status', id=task.id, status='in-review') }}" method="POST" class="d-inline">
                                <button type="submit" class="btn btn-sm {{ 'btn-info' if task.status == 'in-review' else 'btn-outline-info' }}">In Review</button>
                            </form>
                            
                            <form action="{{ url_for('project_management.update_task_status', id=task.id, status='completed') }}" method="POST" class="d-inline">
                                <button type="submit" class="btn btn-sm {{ 'btn-success' if task.status == 'completed' else 'btn-outline-success' }}">Completed</button>
                            </form>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                {% if current_user.is_admin or task.user_id == current_user.id %}
                <a href="{{ url_for('project_management.edit_task', id=task.id) }}" class="btn btn-primary">Edit</a>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Task Delete Modals -->
<div class="modal fade" id="deleteTaskModal{{ task.id }}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete the task <strong>{{ task.title }}</strong>? This action cannot be undone.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form action="{{ url_for('project_management.delete_task', id=task.id) }}" method="POST">
                    <button type="submit" class="btn btn-danger">Delete</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endfor %}
{% endblock %}
